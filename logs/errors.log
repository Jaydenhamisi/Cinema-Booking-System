{"timestamp": "2025-12-27T16:29:18.087932+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.021s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "e56790c2-9cd1-475f-a081-830aeb7335f5", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2522, in get_property\n    return self._props[key]\n           ~~~~~~~~~~~^^^^^\nKeyError: 'reservations'\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1660, in do_init\n    self._generate_backref()\n    ~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 2144, in _generate_backref\n    self._add_reverse_property(self.back_populates)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1591, in _add_reverse_property\n    other = self.mapper.get_property(key, _configure_mappers=False)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2524, in get_property\n    raise sa_exc.InvalidRequestError(\n    ...<3 lines>...\n    ) from err\nsqlalchemy.exc.InvalidRequestError: Mapper 'Mapper[Showtime(showtimes)]' has no property 'reservations'.  If this property was indicated from other mappers or configure events, ensure registry.configure() has been called."}
{"timestamp": "2025-12-27T16:34:34.080919+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.017s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "6c84ccb4-5fb1-4d9d-b16f-965093250dab", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T16:45:16.226848+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.017s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "e1068fbf-afe1-4216-afd7-8975f8a9ce3a", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T16:59:02.234020+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.020s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "7e0351f3-cbff-4aaf-a0ec-03c2ac5d019f", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T17:02:39.184054+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.016s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "654ca670-ad90-45ba-b125-17e17859c2c7", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T17:05:07.640156+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.018s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "211e011c-0a4a-4b16-8ecf-1306d3577d44", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T17:06:15.885325+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.017s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "e4a894ac-b3b9-4a5a-aac6-b933a055d289", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T17:08:10.576153+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.016s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "aeb5f5fe-7147-4f91-ac0f-9bbc1b28728c", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1655, in do_init\n    self._setup_entity()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1880, in _setup_entity\n    entity = inspect(resolved_argument)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\inspection.py\", line 140, in inspect\n    ret = reg(subject)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\base.py\", line 430, in _inspect_mapped_object\n    return instance_state(instance)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\clsregistry.py\", line 350, in __getattr__\n    raise NameError(\n    ...<2 lines>...\n    )\nNameError: Module 'reservation' has no mapped classes registered under the name '_sa_instance_state'"}
{"timestamp": "2025-12-27T17:12:10.305863+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.019s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "7dbd7b68-53dd-4dc8-afc6-5197573ba803", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2522, in get_property\n    return self._props[key]\n           ~~~~~~~~~~~^^^^^\nKeyError: 'orders'\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1660, in do_init\n    self._generate_backref()\n    ~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 2144, in _generate_backref\n    self._add_reverse_property(self.back_populates)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1591, in _add_reverse_property\n    other = self.mapper.get_property(key, _configure_mappers=False)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2524, in get_property\n    raise sa_exc.InvalidRequestError(\n    ...<3 lines>...\n    ) from err\nsqlalchemy.exc.InvalidRequestError: Mapper 'Mapper[Reservation(reservations)]' has no property 'orders'.  If this property was indicated from other mappers or configure events, ensure registry.configure() has been called."}
{"timestamp": "2025-12-27T17:13:26.547536+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (0.021s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "47324cec-41c2-491d-b825-f3ae95ccd7fe", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2522, in get_property\n    return self._props[key]\n           ~~~~~~~~~~~^^^^^\nKeyError: 'payment_attempts'\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 11, in get_user_by_email\n    db.query(UserCredential)\n    ~~~~~~~~^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2941, in query\n    return self._query_cls(entities, self, **kwargs)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 276, in __init__\n    self._set_entities(entities)\n    ~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 289, in _set_entities\n    coercions.expect(\n    ~~~~~~~~~~~~~~~~^\n        roles.ColumnsClauseRole,\n        ^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n        post_inspect=True,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\coercions.py\", line 388, in expect\n    insp._post_inspect\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 1338, in __get__\n    obj.__dict__[self.__name__] = result = self.fget(obj)\n                                           ~~~~~~~~~^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2724, in _post_inspect\n    self._check_configure()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2401, in _check_configure\n    _configure_registries({self.registry}, cascade=True)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4218, in _configure_registries\n    _do_configure_registries(registries, cascade)\n    ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 4259, in _do_configure_registries\n    mapper._post_configure_properties()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2418, in _post_configure_properties\n    prop.init()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\interfaces.py\", line 595, in init\n    self.do_init()\n    ~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1660, in do_init\n    self._generate_backref()\n    ~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 2144, in _generate_backref\n    self._add_reverse_property(self.back_populates)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\relationships.py\", line 1591, in _add_reverse_property\n    other = self.mapper.get_property(key, _configure_mappers=False)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\mapper.py\", line 2524, in get_property\n    raise sa_exc.InvalidRequestError(\n    ...<3 lines>...\n    ) from err\nsqlalchemy.exc.InvalidRequestError: Mapper 'Mapper[Order(orders)]' has no property 'payment_attempts'.  If this property was indicated from other mappers or configure events, ensure registry.configure() has been called."}
{"timestamp": "2025-12-27T17:39:45.063577+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /movies/ \u2192 FAILED (0.011s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "f9778578-89a9-42c8-9f28-b7c4aff84e46", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\movie\\router.py\", line 34, in create_movie_route\n    return create_movie(db=db, data=payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\movie\\service.py\", line 27, in create_movie\n    raise ConflictError (\"Title already exists.\")\napp.core.errors.ConflictError: Title already exists."}
{"timestamp": "2025-12-28T15:06:52.193838+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "Event handler failed: reservation.created -> on_reservation_created", "module": "event_bus", "function": "_safe_invoke", "line": 33, "request_id": "9cce2596-40f4-4310-80f2-ac849a25d1f3", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 18, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 31, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 27, in lock_seat\n    raise NotFoundError(\"Seat does not exist\", {\"seat_code\": seat_code})\napp.core.errors.NotFoundError: ('Seat does not exist', {'seat_code': 'R5-8'})"}
{"timestamp": "2025-12-28T15:10:09.084988+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "Event handler failed: reservation.created -> on_reservation_created", "module": "event_bus", "function": "_safe_invoke", "line": 33, "request_id": "32e87030-7f20-4f2d-929e-ad125b1125b9", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 18, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 31, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 27, in lock_seat\n    raise NotFoundError(\"Seat does not exist\", {\"seat_code\": seat_code})\napp.core.errors.NotFoundError: ('Seat does not exist', {'seat_code': 'R5-8'})"}
{"timestamp": "2025-12-28T15:18:07.328417+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.created -> on_reservation_created: ('Seat does not exist', {'seat_code': 'R5-8'})", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "87c5d3b4-14df-41b5-a568-c46003975705", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 23, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 27, in lock_seat\n    raise NotFoundError(\"Seat does not exist\", {\"seat_code\": seat_code})\napp.core.errors.NotFoundError: ('Seat does not exist', {'seat_code': 'R5-8'})"}
{"timestamp": "2025-12-28T15:48:11.225853+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/1/confirm \u2192 FAILED (0.016s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "0f472a9c-6f88-4fff-a3a3-968d1d12783a", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T15:56:55.095772+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/2/confirm \u2192 FAILED (0.014s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "7e755f5c-2c90-48e2-b0a0-175c623e77f8", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:03:30.428197+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/3/confirm \u2192 FAILED (0.016s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "9e16c3ae-9fda-4269-ae08-1604b6bae2b8", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:06:26.243713+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: auth.user_registered -> on_user_registered: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "c00d27f8-b1a9-45a4-b450-5a31e4b60e6b", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\handlers.py\", line 19, in on_user_registered\n    profile_service.create_profile(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n        email=email,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\service.py\", line 41, in create_profile\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 20, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-28T16:06:26.878420+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.created -> on_reservation_created: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "1e652a68-c7c0-4243-b58b-1f4c1728efe9", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 62, in lock_seat\n    publish_event(\n    ~~~~~~~~~~~~~^\n        \"seat.locked\",\n        ^^^^^^^^^^^^^^\n    ...<5 lines>...\n        },\n        ^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 20, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-28T16:06:26.897656+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.contexts.order.handlers", "message": "Failed to create order from reservation: asyncio.run() cannot be called from a running event loop", "module": "handlers", "function": "on_reservation_created", "line": 43, "request_id": "1e652a68-c7c0-4243-b58b-1f4c1728efe9", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\handlers.py\", line 34, in on_reservation_created\n    create_order_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<3 lines>...\n        seat_code=seat_code,\n        ^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\service.py\", line 41, in create_order_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 20, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-28T16:06:26.992099+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/4/confirm \u2192 FAILED (0.018s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "e76fa6eb-a6de-4e80-a8c8-baa5dd1668bb", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:08:39.577988+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/5/confirm \u2192 FAILED (0.016s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "f6a8eacb-f289-41cf-8393-a9c91099e819", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:11:54.515059+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/6/confirm \u2192 FAILED (0.014s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "32f394cb-93b3-4668-ad30-45f4b6519f79", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:13:06.485323+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: auth.user_registered -> on_user_registered: ", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "f9eb86a2-ba4a-471b-b65f-28dc19d104b6", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\handlers.py\", line 19, in on_user_registered\n    profile_service.create_profile(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n        email=email,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\service.py\", line 41, in create_profile\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:13:17.165891+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.created -> on_reservation_created: ", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "457739ff-de95-4512-9985-26010b443e87", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 62, in lock_seat\n    publish_event(\n    ~~~~~~~~~~~~~^\n        \"seat.locked\",\n        ^^^^^^^^^^^^^^\n    ...<5 lines>...\n        },\n        ^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:13:27.190236+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.contexts.order.handlers", "message": "Failed to create order from reservation: ", "module": "handlers", "function": "on_reservation_created", "line": 43, "request_id": "457739ff-de95-4512-9985-26010b443e87", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\handlers.py\", line 34, in on_reservation_created\n    create_order_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<3 lines>...\n        seat_code=seat_code,\n        ^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\service.py\", line 41, in create_order_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:13:37.233789+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: order.created -> on_order_created: ", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "457739ff-de95-4512-9985-26010b443e87", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\pricing\\handlers.py\", line 23, in on_order_created\n    create_snapshot_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n        order_id=order_id,\n        ^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\pricing\\service.py\", line 53, in create_snapshot_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:13:37.325742+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "asyncio", "message": "Task was destroyed but it is pending!\ntask: <Task pending name='Task-52' coro=<EventBus.publish() running at C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py:24> cb=[_chain_future.<locals>._call_set_state() at C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\futures.py:391]>", "module": "base_events", "function": "default_exception_handler", "line": 1871, "request_id": "7bb3456f-774f-4eb4-81b7-87fed8262ad5"}
{"timestamp": "2025-12-28T16:13:37.334240+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/7/confirm \u2192 FAILED (0.018s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "7bb3456f-774f-4eb4-81b7-87fed8262ad5", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:21:40.425552+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: auth.user_registered -> on_user_registered: ", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "8f3a40df-b3ed-4cd2-a9a1-74ae6a85fb1d", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\handlers.py\", line 19, in on_user_registered\n    profile_service.create_profile(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n        email=email,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\service.py\", line 41, in create_profile\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:21:51.065519+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.created -> on_reservation_created: ", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "02eec0a4-fe5d-4c48-83c1-a5fdbc75b2af", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 62, in lock_seat\n    publish_event(\n    ~~~~~~~~~~~~~^\n        \"seat.locked\",\n        ^^^^^^^^^^^^^^\n    ...<5 lines>...\n        },\n        ^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:22:01.096315+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.contexts.order.handlers", "message": "Failed to create order from reservation: ", "module": "handlers", "function": "on_reservation_created", "line": 43, "request_id": "02eec0a4-fe5d-4c48-83c1-a5fdbc75b2af", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\handlers.py\", line 34, in on_reservation_created\n    create_order_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<3 lines>...\n        seat_code=seat_code,\n        ^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\service.py\", line 41, in create_order_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:22:11.131796+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.contexts.pricing.handlers", "message": "\u274c Failed to create pricing snapshot for order 15: ", "module": "handlers", "function": "on_order_created", "line": 36, "request_id": "02eec0a4-fe5d-4c48-83c1-a5fdbc75b2af"}
{"timestamp": "2025-12-28T16:22:11.136740+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: order.created -> on_order_created: ", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "02eec0a4-fe5d-4c48-83c1-a5fdbc75b2af", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 21, in publish_event\n    loop = asyncio.get_running_loop()\nRuntimeError: no running event loop\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\pricing\\handlers.py\", line 30, in on_order_created\n    result = await create_snapshot_from_event(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<2 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\pricing\\service.py\", line 62, in create_snapshot_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 34, in publish_event\n    future.result(timeout=10.0)  # 10 second timeout\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\concurrent\\futures\\_base.py\", line 458, in result\n    raise TimeoutError()\nTimeoutError"}
{"timestamp": "2025-12-28T16:22:11.218196+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "asyncio", "message": "Task was destroyed but it is pending!\ntask: <Task pending name='Task-52' coro=<EventBus.publish() running at C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py:24> cb=[_chain_future.<locals>._call_set_state() at C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\futures.py:391]>", "module": "base_events", "function": "default_exception_handler", "line": 1871, "request_id": "68e05875-1dba-4efc-a225-78340f364c7b"}
{"timestamp": "2025-12-28T16:22:11.237939+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/8/confirm \u2192 FAILED (0.016s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "68e05875-1dba-4efc-a225-78340f364c7b", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-28T16:26:06.244598+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: auth.user_registered -> on_user_registered: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "1f8836eb-0ce9-4d43-a6f9-a9b8ee1b7241", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\handlers.py\", line 19, in on_user_registered\n    profile_service.create_profile(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n        email=email,\n        ^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\user\\service.py\", line 41, in create_profile\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-28T16:26:06.870958+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.created -> on_reservation_created: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 43, "request_id": "720bf9e0-25c0-4d71-9d79-aed408e9a499", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 40, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 24, in on_reservation_created\n    seat_service.lock_seat(\n    ~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        user_id=user_id,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 62, in lock_seat\n    publish_event(\n    ~~~~~~~~~~~~~^\n        \"seat.locked\",\n        ^^^^^^^^^^^^^^\n    ...<5 lines>...\n        },\n        ^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-28T16:26:06.890408+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.contexts.order.handlers", "message": "Failed to create order from reservation: asyncio.run() cannot be called from a running event loop", "module": "handlers", "function": "on_reservation_created", "line": 43, "request_id": "720bf9e0-25c0-4d71-9d79-aed408e9a499", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\handlers.py\", line 34, in on_reservation_created\n    create_order_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<3 lines>...\n        seat_code=seat_code,\n        ^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\service.py\", line 41, in create_order_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-28T16:26:06.977772+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/9/confirm \u2192 FAILED (0.015s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "461cdaa6-43c4-4d5b-8576-1726f0e9c1ff", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-29T12:30:22.684812+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /auth/register \u2192 FAILED (4.116s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "37eed2d5-07c3-43de-9f2f-b4abea3bfc2a", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 143, in __init__\n    self._dbapi_connection = engine.raw_connection()\n                             ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 3301, in raw_connection\n    return self.pool.connect()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 447, in connect\n    return _ConnectionFairy._checkout(self)\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 1264, in _checkout\n    fairy = _ConnectionRecord.checkout(pool)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 711, in checkout\n    rec = pool._do_get()\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\impl.py\", line 177, in _do_get\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\impl.py\", line 175, in _do_get\n    return self._create_connection()\n           ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 388, in _create_connection\n    return _ConnectionRecord(self)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 673, in __init__\n    self.__connect()\n    ~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 899, in __connect\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 895, in __connect\n    self.dbapi_connection = connection = pool._invoke_creator(self)\n                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\create.py\", line 661, in connect\n    return dialect.connect(*cargs, **cparams)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 629, in connect\n    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\psycopg2\\__init__.py\", line 135, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\npsycopg2.OperationalError: connection to server at \"localhost\" (::1), port 5432 failed: Connection refused (0x0000274D/10061)\n\tIs the server running on that host and accepting TCP/IP connections?\nconnection to server at \"localhost\" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)\n\tIs the server running on that host and accepting TCP/IP connections?\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\router.py\", line 32, in register\n    user = auth_service.register_user(db, payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\service.py\", line 40, in register_user\n    existing = self.repo.get_user_by_email(db, payload.email)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\auth\\repository.py\", line 13, in get_user_by_email\n    .first()\n     ~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 2759, in first\n    return self.limit(1)._iter().first()  # type: ignore\n           ~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\query.py\", line 2857, in _iter\n    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(\n                                                  ~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n        params,\n        ^^^^^^^\n        execution_options={\"_sa_orm_load_options\": self.load_options},\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2351, in execute\n    return self._execute_internal(\n           ~~~~~~~~~~~~~~~~~~~~~~^\n        statement,\n        ^^^^^^^^^^\n    ...<4 lines>...\n        _add_event=_add_event,\n        ^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2239, in _execute_internal\n    conn = self._connection_for_bind(bind)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2108, in _connection_for_bind\n    return trans._connection_for_bind(engine, execution_options)\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in _connection_for_bind\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1187, in _connection_for_bind\n    conn = bind.connect()\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 3277, in connect\n    return self._connection_cls(self)\n           ~~~~~~~~~~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 145, in __init__\n    Connection._handle_dbapi_exception_noconnection(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        err, dialect, engine\n        ^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2440, in _handle_dbapi_exception_noconnection\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 143, in __init__\n    self._dbapi_connection = engine.raw_connection()\n                             ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 3301, in raw_connection\n    return self.pool.connect()\n           ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 447, in connect\n    return _ConnectionFairy._checkout(self)\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 1264, in _checkout\n    fairy = _ConnectionRecord.checkout(pool)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 711, in checkout\n    rec = pool._do_get()\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\impl.py\", line 177, in _do_get\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\impl.py\", line 175, in _do_get\n    return self._create_connection()\n           ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 388, in _create_connection\n    return _ConnectionRecord(self)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 673, in __init__\n    self.__connect()\n    ~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 899, in __connect\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\pool\\base.py\", line 895, in __connect\n    self.dbapi_connection = connection = pool._invoke_creator(self)\n                                         ~~~~~~~~~~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\create.py\", line 661, in connect\n    return dialect.connect(*cargs, **cparams)\n           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 629, in connect\n    return self.loaded_dbapi.connect(*cargs, **cparams)  # type: ignore[no-any-return]  # NOQA: E501\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\psycopg2\\__init__.py\", line 135, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\nsqlalchemy.exc.OperationalError: (psycopg2.OperationalError) connection to server at \"localhost\" (::1), port 5432 failed: Connection refused (0x0000274D/10061)\n\tIs the server running on that host and accepting TCP/IP connections?\nconnection to server at \"localhost\" (127.0.0.1), port 5432 failed: Connection refused (0x0000274D/10061)\n\tIs the server running on that host and accepting TCP/IP connections?\n\n(Background on this error at: https://sqlalche.me/e/20/e3q8)"}
{"timestamp": "2025-12-29T12:31:47.103971+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/10/confirm \u2192 FAILED (0.013s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "f79b2b1c-8b75-4dde-8c2d-5278c3f065d6", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-29T12:36:57.529996+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.contexts.order.handlers", "message": "Failed to update order pricing: 'OrderRepository' object has no attribute 'get_by_id'", "module": "handlers", "function": "on_pricing_snapshot_created", "line": 114, "request_id": "2930f3c6-ff7c-462c-90fc-28f9dfa50206", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\order\\handlers.py\", line 100, in on_pricing_snapshot_created\n    order = repo.get_by_id(db, order_id)\n            ^^^^^^^^^^^^^^\nAttributeError: 'OrderRepository' object has no attribute 'get_by_id'"}
{"timestamp": "2025-12-29T12:36:57.616589+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/11/confirm \u2192 FAILED (0.014s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "2f880832-3145-4b2f-9fa7-94df960df245", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-29T12:40:46.544741+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /payments/12/confirm \u2192 FAILED (0.015s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "971a55fc-8e76-484f-bc99-0c881bdd3f36", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\router.py\", line 50, in confirm_payment_route\n    return mark_payment_succeeded(\n        db=db,\n        payment_attempt_id=payment_attempt_id,\n        provider_payment_id=provider_payment_id\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\payment\\service.py\", line 66, in mark_payment_succeeded\n    raise ValidationError(\"Final amount not equal to order amount\")\napp.core.errors.ValidationError: Final amount not equal to order amount"}
{"timestamp": "2025-12-29T12:46:22.987686+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: payment.succeeded -> on_payment_succeeded: 'user_email'", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "9bc0eae0-e149-4d7c-bf95-59463fc50525", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\notification\\handlers.py\", line 11, in on_payment_succeeded\n    send_booking_confirmation(payload)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\notification\\service.py\", line 31, in send_booking_confirmation\n    to_email=payload[\"user_email\"],\n             ~~~~~~~^^^^^^^^^^^^^^\nKeyError: 'user_email'"}
{"timestamp": "2025-12-29T12:46:23.062012+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: payment.succeeded -> on_payment_succeeded: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (21, null, user, payment.succeeded, 20, order, {\"payment_attempt_id\": 13, \"order_id\": 20, \"final_amount\": 1000...., null, 2025-12-29 12:46:22.990215+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'payment.succeeded', 'target_id': 20, 'target_type': 'order', 'payload': '{\"payment_attempt_id\": 13, \"order_id\": 20, \"final_amount\": 1000.0}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 12, 46, 22, 990215, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "9bc0eae0-e149-4d7c-bf95-59463fc50525", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\npsycopg2.errors.NotNullViolation: null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (21, null, user, payment.succeeded, 20, order, {\"payment_attempt_id\": 13, \"order_id\": 20, \"final_amount\": 1000...., null, 2025-12-29 12:46:22.990215+00).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\handlers.py\", line 44, in on_payment_succeeded\n    write_audit_log(\n    ~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n    ...<5 lines>...\n        payload=payload,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\service.py\", line 31, in write_audit_log\n    return repo.create(db, entry)\n           ~~~~~~~~~~~^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\repository.py\", line 17, in create\n    db.commit()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2030, in commit\n    trans.commit(_to_root=True)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in commit\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1311, in commit\n    self._prepare_impl()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"<string>\", line 2, in _prepare_impl\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1286, in _prepare_impl\n    self.session.flush()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4331, in flush\n    self._flush(objects)\n    ~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4466, in _flush\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4427, in _flush\n    flush_context.execute()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 466, in execute\n    rec.execute(self)\n    ~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self.mapper,\n        ^^^^^^^^^^^^\n        uow.states_for_mapper_hierarchy(self.mapper, False, False),\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        uow,\n        ^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        base_mapper,\n        ^^^^^^^^^^^^\n    ...<3 lines>...\n        insert,\n        ^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 1233, in _emit_insert_statements\n    result = connection.execute(\n        statement,\n        params,\n        execution_options=execution_options,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (21, null, user, payment.succeeded, 20, order, {\"payment_attempt_id\": 13, \"order_id\": 20, \"final_amount\": 1000...., null, 2025-12-29 12:46:22.990215+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'payment.succeeded', 'target_id': 20, 'target_type': 'order', 'payload': '{\"payment_attempt_id\": 13, \"order_id\": 20, \"final_amount\": 1000.0}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 12, 46, 22, 990215, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-12-29T12:50:11.531676+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: payment.succeeded -> on_payment_succeeded: 'user_email'", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "40dc0c42-4472-4253-885f-5e67d1b053d2", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\notification\\handlers.py\", line 11, in on_payment_succeeded\n    send_booking_confirmation(payload)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\notification\\service.py\", line 31, in send_booking_confirmation\n    to_email=payload[\"user_email\"],\n             ~~~~~~~^^^^^^^^^^^^^^\nKeyError: 'user_email'"}
{"timestamp": "2025-12-29T12:50:11.560077+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: payment.succeeded -> on_payment_succeeded: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (23, null, user, payment.succeeded, 21, order, {\"payment_attempt_id\": 14, \"order_id\": 21, \"final_amount\": 1000...., null, 2025-12-29 12:50:11.534488+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'payment.succeeded', 'target_id': 21, 'target_type': 'order', 'payload': '{\"payment_attempt_id\": 14, \"order_id\": 21, \"final_amount\": 1000.0}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 12, 50, 11, 534488, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "40dc0c42-4472-4253-885f-5e67d1b053d2", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\npsycopg2.errors.NotNullViolation: null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (23, null, user, payment.succeeded, 21, order, {\"payment_attempt_id\": 14, \"order_id\": 21, \"final_amount\": 1000...., null, 2025-12-29 12:50:11.534488+00).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\handlers.py\", line 44, in on_payment_succeeded\n    write_audit_log(\n    ~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n    ...<5 lines>...\n        payload=payload,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\service.py\", line 31, in write_audit_log\n    return repo.create(db, entry)\n           ~~~~~~~~~~~^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\repository.py\", line 17, in create\n    db.commit()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2030, in commit\n    trans.commit(_to_root=True)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in commit\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1311, in commit\n    self._prepare_impl()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"<string>\", line 2, in _prepare_impl\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1286, in _prepare_impl\n    self.session.flush()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4331, in flush\n    self._flush(objects)\n    ~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4466, in _flush\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4427, in _flush\n    flush_context.execute()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 466, in execute\n    rec.execute(self)\n    ~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self.mapper,\n        ^^^^^^^^^^^^\n        uow.states_for_mapper_hierarchy(self.mapper, False, False),\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        uow,\n        ^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        base_mapper,\n        ^^^^^^^^^^^^\n    ...<3 lines>...\n        insert,\n        ^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 1233, in _emit_insert_statements\n    result = connection.execute(\n        statement,\n        params,\n        execution_options=execution_options,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (23, null, user, payment.succeeded, 21, order, {\"payment_attempt_id\": 14, \"order_id\": 21, \"final_amount\": 1000...., null, 2025-12-29 12:50:11.534488+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'payment.succeeded', 'target_id': 21, 'target_type': 'order', 'payload': '{\"payment_attempt_id\": 14, \"order_id\": 21, \"final_amount\": 1000.0}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 12, 50, 11, 534488, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-12-29T13:30:01.826096+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "ac8711a6-990c-4ba8-ab03-7727698bcc10", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\handlers.py\", line 34, in on_reservation_cancelled\n    issue_refund_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        reason=\"reservation_cancelled\"\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\service.py\", line 58, in issue_refund_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-29T13:30:01.858523+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (30, null, user, reservation.cancelled, 24, reservation, {\"reservation_id\": 24}, null, 2025-12-29 13:30:01.831705+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 24, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 24}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 30, 1, 831705, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "ac8711a6-990c-4ba8-ab03-7727698bcc10", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\npsycopg2.errors.NotNullViolation: null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (30, null, user, reservation.cancelled, 24, reservation, {\"reservation_id\": 24}, null, 2025-12-29 13:30:01.831705+00).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\handlers.py\", line 28, in on_reservation_cancelled\n    write_audit_log(\n    ~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n    ...<5 lines>...\n        payload=payload,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\service.py\", line 31, in write_audit_log\n    return repo.create(db, entry)\n           ~~~~~~~~~~~^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\repository.py\", line 17, in create\n    db.commit()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2030, in commit\n    trans.commit(_to_root=True)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in commit\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1311, in commit\n    self._prepare_impl()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"<string>\", line 2, in _prepare_impl\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1286, in _prepare_impl\n    self.session.flush()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4331, in flush\n    self._flush(objects)\n    ~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4466, in _flush\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4427, in _flush\n    flush_context.execute()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 466, in execute\n    rec.execute(self)\n    ~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self.mapper,\n        ^^^^^^^^^^^^\n        uow.states_for_mapper_hierarchy(self.mapper, False, False),\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        uow,\n        ^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        base_mapper,\n        ^^^^^^^^^^^^\n    ...<3 lines>...\n        insert,\n        ^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 1233, in _emit_insert_statements\n    result = connection.execute(\n        statement,\n        params,\n        execution_options=execution_options,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (30, null, user, reservation.cancelled, 24, reservation, {\"reservation_id\": 24}, null, 2025-12-29 13:30:01.831705+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 24, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 24}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 30, 1, 831705, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-12-29T13:31:00.963475+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.created -> on_reservation_created: ('Seat locked by another user', {'locked_by': 55, 'attempt_user': 56})", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "c0be121d-4a14-4754-8beb-8e0c3584233d", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\handlers.py\", line 23, in on_reservation_created\n    await seat_service.lock_seat(  # Added await!\n    ...<4 lines>...\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\seat_availability\\service.py\", line 49, in lock_seat\n    raise ValidationError(\n    ...<2 lines>...\n    )\napp.core.errors.ValidationError: ('Seat locked by another user', {'locked_by': 55, 'attempt_user': 56})"}
{"timestamp": "2025-12-29T13:37:32.065886+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "8bf8ba06-0f27-4fb3-8ab0-ee9ba0c11d1a", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\handlers.py\", line 34, in on_reservation_cancelled\n    issue_refund_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        reason=\"reservation_cancelled\"\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\service.py\", line 58, in issue_refund_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-29T13:37:32.095003+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (39, null, user, reservation.cancelled, 30, reservation, {\"reservation_id\": 30}, null, 2025-12-29 13:37:32.070885+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 30, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 30}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 37, 32, 70885, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "8bf8ba06-0f27-4fb3-8ab0-ee9ba0c11d1a", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\npsycopg2.errors.NotNullViolation: null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (39, null, user, reservation.cancelled, 30, reservation, {\"reservation_id\": 30}, null, 2025-12-29 13:37:32.070885+00).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\handlers.py\", line 28, in on_reservation_cancelled\n    write_audit_log(\n    ~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n    ...<5 lines>...\n        payload=payload,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\service.py\", line 31, in write_audit_log\n    return repo.create(db, entry)\n           ~~~~~~~~~~~^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\repository.py\", line 17, in create\n    db.commit()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2030, in commit\n    trans.commit(_to_root=True)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in commit\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1311, in commit\n    self._prepare_impl()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"<string>\", line 2, in _prepare_impl\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1286, in _prepare_impl\n    self.session.flush()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4331, in flush\n    self._flush(objects)\n    ~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4466, in _flush\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4427, in _flush\n    flush_context.execute()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 466, in execute\n    rec.execute(self)\n    ~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self.mapper,\n        ^^^^^^^^^^^^\n        uow.states_for_mapper_hierarchy(self.mapper, False, False),\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        uow,\n        ^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        base_mapper,\n        ^^^^^^^^^^^^\n    ...<3 lines>...\n        insert,\n        ^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 1233, in _emit_insert_statements\n    result = connection.execute(\n        statement,\n        params,\n        execution_options=execution_options,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (39, null, user, reservation.cancelled, 30, reservation, {\"reservation_id\": 30}, null, 2025-12-29 13:37:32.070885+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 30, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 30}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 37, 32, 70885, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-12-29T13:38:31.164885+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /reservations/ \u2192 FAILED (0.012s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "40ee2511-eb19-41d9-b41b-48979f3dcbdf", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\router.py\", line 31, in create_reservation_route\n    return create_reservation(db=db, user_id=current_user.id, data=payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\service.py\", line 53, in create_reservation\n    raise ValidationError(\n    ...<2 lines>...\n    )\napp.core.errors.ValidationError: ('Seat is locked by another user', {'seat_code': 'R9-9'})"}
{"timestamp": "2025-12-29T13:43:09.533319+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "afdafbb5-1e5f-4c61-8e79-9d172c01e719", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\handlers.py\", line 34, in on_reservation_cancelled\n    issue_refund_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        reason=\"reservation_cancelled\"\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\service.py\", line 58, in issue_refund_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-29T13:43:09.560313+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (47, null, user, reservation.cancelled, 35, reservation, {\"reservation_id\": 35}, null, 2025-12-29 13:43:09.538142+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 35, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 35}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 43, 9, 538142, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "afdafbb5-1e5f-4c61-8e79-9d172c01e719", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\npsycopg2.errors.NotNullViolation: null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (47, null, user, reservation.cancelled, 35, reservation, {\"reservation_id\": 35}, null, 2025-12-29 13:43:09.538142+00).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\handlers.py\", line 28, in on_reservation_cancelled\n    write_audit_log(\n    ~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n    ...<5 lines>...\n        payload=payload,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\service.py\", line 31, in write_audit_log\n    return repo.create(db, entry)\n           ~~~~~~~~~~~^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\repository.py\", line 17, in create\n    db.commit()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2030, in commit\n    trans.commit(_to_root=True)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in commit\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1311, in commit\n    self._prepare_impl()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"<string>\", line 2, in _prepare_impl\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1286, in _prepare_impl\n    self.session.flush()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4331, in flush\n    self._flush(objects)\n    ~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4466, in _flush\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4427, in _flush\n    flush_context.execute()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 466, in execute\n    rec.execute(self)\n    ~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self.mapper,\n        ^^^^^^^^^^^^\n        uow.states_for_mapper_hierarchy(self.mapper, False, False),\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        uow,\n        ^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        base_mapper,\n        ^^^^^^^^^^^^\n    ...<3 lines>...\n        insert,\n        ^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 1233, in _emit_insert_statements\n    result = connection.execute(\n        statement,\n        params,\n        execution_options=execution_options,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (47, null, user, reservation.cancelled, 35, reservation, {\"reservation_id\": 35}, null, 2025-12-29 13:43:09.538142+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 35, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 35}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 43, 9, 538142, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-12-29T13:44:08.649594+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /reservations/ \u2192 FAILED (0.017s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "d599c239-cb07-4465-b7c4-0051c08e658e", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\router.py\", line 31, in create_reservation_route\n    return create_reservation(db=db, user_id=current_user.id, data=payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\service.py\", line 53, in create_reservation\n    raise ValidationError(\n    ...<2 lines>...\n    )\napp.core.errors.ValidationError: ('Seat is locked by another user', {'seat_code': 'R9-9'})"}
{"timestamp": "2025-12-29T13:48:27.994333+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "c8e4e110-6a50-4c4c-b2f6-8cf4f2f27a2f", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\handlers.py\", line 34, in on_reservation_cancelled\n    issue_refund_from_event(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n    ...<2 lines>...\n        reason=\"reservation_cancelled\"\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\refund\\service.py\", line 58, in issue_refund_from_event\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-29T13:48:28.023566+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: reservation.cancelled -> on_reservation_cancelled: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (55, null, user, reservation.cancelled, 40, reservation, {\"reservation_id\": 40}, null, 2025-12-29 13:48:27.999453+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 40, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 40}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 48, 27, 999453, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "c8e4e110-6a50-4c4c-b2f6-8cf4f2f27a2f", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\npsycopg2.errors.NotNullViolation: null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (55, null, user, reservation.cancelled, 40, reservation, {\"reservation_id\": 40}, null, 2025-12-29 13:48:27.999453+00).\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\handlers.py\", line 28, in on_reservation_cancelled\n    write_audit_log(\n    ~~~~~~~~~~~~~~~^\n        db=db,\n        ^^^^^^\n    ...<5 lines>...\n        payload=payload,\n        ^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\service.py\", line 31, in write_audit_log\n    return repo.create(db, entry)\n           ~~~~~~~~~~~^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\audit\\repository.py\", line 17, in create\n    db.commit()\n    ~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 2030, in commit\n    trans.commit(_to_root=True)\n    ~~~~~~~~~~~~^^^^^^^^^^^^^^^\n  File \"<string>\", line 2, in commit\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1311, in commit\n    self._prepare_impl()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"<string>\", line 2, in _prepare_impl\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\state_changes.py\", line 137, in _go\n    ret_value = fn(self, *arg, **kw)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 1286, in _prepare_impl\n    self.session.flush()\n    ~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4331, in flush\n    self._flush(objects)\n    ~~~~~~~~~~~^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4466, in _flush\n    with util.safe_reraise():\n         ~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\util\\langhelpers.py\", line 224, in __exit__\n    raise exc_value.with_traceback(exc_tb)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\session.py\", line 4427, in _flush\n    flush_context.execute()\n    ~~~~~~~~~~~~~~~~~~~~~^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 466, in execute\n    rec.execute(self)\n    ~~~~~~~~~~~^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\unitofwork.py\", line 642, in execute\n    util.preloaded.orm_persistence.save_obj(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self.mapper,\n        ^^^^^^^^^^^^\n        uow.states_for_mapper_hierarchy(self.mapper, False, False),\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        uow,\n        ^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 93, in save_obj\n    _emit_insert_statements(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        base_mapper,\n        ^^^^^^^^^^^^\n    ...<3 lines>...\n        insert,\n        ^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\orm\\persistence.py\", line 1233, in _emit_insert_statements\n    result = connection.execute(\n        statement,\n        params,\n        execution_options=execution_options,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1419, in execute\n    return meth(\n        self,\n        distilled_parameters,\n        execution_options or NO_OPTIONS,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\sql\\elements.py\", line 526, in _execute_on_connection\n    return connection._execute_clauseelement(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        self, distilled_params, execution_options\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1641, in _execute_clauseelement\n    ret = self._execute_context(\n        dialect,\n    ...<8 lines>...\n        cache_hit=cache_hit,\n    )\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1846, in _execute_context\n    return self._exec_single_context(\n           ~~~~~~~~~~~~~~~~~~~~~~~~~^\n        dialect, context, statement, parameters\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1986, in _exec_single_context\n    self._handle_dbapi_exception(\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\n        e, str_statement, effective_parameters, cursor, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 2355, in _handle_dbapi_exception\n    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\base.py\", line 1967, in _exec_single_context\n    self.dialect.do_execute(\n    ~~~~~~~~~~~~~~~~~~~~~~~^\n        cursor, str_statement, effective_parameters, context\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\sqlalchemy\\engine\\default.py\", line 951, in do_execute\n    cursor.execute(statement, parameters)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^\nsqlalchemy.exc.IntegrityError: (psycopg2.errors.NotNullViolation) null value in column \"actor_id\" of relation \"audit_logs\" violates not-null constraint\nDETAIL:  Failing row contains (55, null, user, reservation.cancelled, 40, reservation, {\"reservation_id\": 40}, null, 2025-12-29 13:48:27.999453+00).\n\n[SQL: INSERT INTO audit_logs (actor_id, actor_type, action, target_id, target_type, payload, request_id, created_at) VALUES (%(actor_id)s, %(actor_type)s, %(action)s, %(target_id)s, %(target_type)s, %(payload)s::JSON, %(request_id)s, %(created_at)s) RETURNING audit_logs.id]\n[parameters: {'actor_id': None, 'actor_type': 'user', 'action': 'reservation.cancelled', 'target_id': 40, 'target_type': 'reservation', 'payload': '{\"reservation_id\": 40}', 'request_id': None, 'created_at': datetime.datetime(2025, 12, 29, 13, 48, 27, 999453, tzinfo=datetime.timezone.utc)}]\n(Background on this error at: https://sqlalche.me/e/20/gkpj)"}
{"timestamp": "2025-12-29T13:49:09.134881+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.event_bus", "message": "\u274c Event handler failed: admin.force_cancel_reservation -> on_admin_force_cancel_reservation: asyncio.run() cannot be called from a running event loop", "module": "event_bus", "function": "_safe_invoke", "line": 45, "request_id": "a74c06ed-d7f4-4ff4-9be6-654e82563d23", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\event_bus.py\", line 42, in _safe_invoke\n    await handler(payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\handlers.py\", line 59, in on_admin_force_cancel_reservation\n    cancel_reservation(\n    ~~~~~~~~~~~~~~~~~~^\n        db,\n        ^^^\n        reservation_id=reservation_id,\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        allow_admin_override=True,\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\service.py\", line 110, in cancel_reservation\n    publish_event(event[\"type\"], event[\"payload\"])\n    ~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\shared\\services\\event_publisher.py\", line 17, in publish_event\n    asyncio.run(event_bus.publish(event_type, payload))\n    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\asyncio\\runners.py\", line 191, in run\n    raise RuntimeError(\n        \"asyncio.run() cannot be called from a running event loop\")\nRuntimeError: asyncio.run() cannot be called from a running event loop"}
{"timestamp": "2025-12-29T13:49:31.302808+00:00", "level": "\u001b[31mERROR\u001b[0m", "logger": "app.core.middleware", "message": "\u2717 POST /reservations/ \u2192 FAILED (0.011s)", "module": "middleware", "function": "dispatch", "line": 83, "request_id": "ddab7466-060b-4d47-9edc-c51c917dec55", "exception": "Traceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 151, in call_next\n    message = await recv_stream.receive()\n              ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\streams\\memory.py\", line 126, in receive\n    raise EndOfStream from None\nanyio.EndOfStream\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\core\\middleware.py\", line 57, in dispatch\n    response = await call_next(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 159, in call_next\n    raise app_exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\base.py\", line 144, in coro\n    await self.app(scope, receive_or_disconnect, send_no_error)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\middleware\\exceptions.py\", line 63, in __call__\n    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\middleware\\asyncexitstack.py\", line 18, in __call__\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 716, in __call__\n    await self.middleware_stack(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 736, in app\n    await route.handle(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\routing.py\", line 290, in handle\n    await self.app(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 124, in app\n    await wrap_app_handling_exceptions(app, request)(scope, receive, send)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 53, in wrapped_app\n    raise exc\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\_exception_handler.py\", line 42, in wrapped_app\n    await app(scope, receive, sender)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 110, in app\n    response = await f(request)\n               ^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 390, in app\n    raw_response = await run_endpoint_function(\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\fastapi\\routing.py\", line 291, in run_endpoint_function\n    return await run_in_threadpool(dependant.call, **values)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\starlette\\concurrency.py\", line 38, in run_in_threadpool\n    return await anyio.to_thread.run_sync(func)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\to_thread.py\", line 56, in run_sync\n    return await get_async_backend().run_sync_in_worker_thread(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        func, args, abandon_on_cancel=abandon_on_cancel, limiter=limiter\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 2485, in run_sync_in_worker_thread\n    return await future\n           ^^^^^^^^^^^^\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\anyio\\_backends\\_asyncio.py\", line 976, in run\n    result = context.run(func, *args)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\router.py\", line 31, in create_reservation_route\n    return create_reservation(db=db, user_id=current_user.id, data=payload)\n  File \"C:\\Users\\Jayja\\AppData\\Local\\Programs\\Python\\Python313\\python_files\\cinema_backend\\app\\contexts\\reservation\\service.py\", line 53, in create_reservation\n    raise ValidationError(\n    ...<2 lines>...\n    )\napp.core.errors.ValidationError: ('Seat is locked by another user', {'seat_code': 'R9-9'})"}
